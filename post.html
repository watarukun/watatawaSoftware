<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>æ²ç¤ºæ¿</title>
  <link rel="icon" href="icon.png" type="image/x-icon" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="index.css">
  <style>
    ul { list-style-type: none; padding-left: 0; }
    .thread > div {
      cursor: pointer;
      background: #eee;
      padding: 8px;
      margin-top: 8px;
    }
    .thread > ul {
      margin-left: 20px;
      padding-left: 10px;
      border-left: 2px solid #ccc;
    }
    button { margin-right: 5px; }

    #form-top, #form-reply {
      border: 1px solid #ccc;
      padding: 8px;
      margin-bottom: 10px;
    }

    textarea {
      width: 100%;
      min-height: 80px;
      resize: vertical;
    }

    #outer {
      max-width: 800px;
      margin: 0 auto;
    }
  </style>
</head>
<body>
  <header>
    <h1>watatawa Software</h1>
    <a href="index.html">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸</a>
    <a href="download.html">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
    <a href="post.html">æ²ç¤ºæ¿</a>
    <a href="guff.html">ã‚¬ãƒ•æœ­æƒ…å ±</a>
    <a href="guffimage.html">ã‚¬ãƒ•ã®å†™çœŸé›†</a>
    <a href="chat.html">ãƒãƒ£ãƒƒãƒˆ</a>
    <a href="market.html">ãƒãƒ¼ã‚±ãƒƒãƒˆã€ã‚¬ãƒ•å¸‚ã€‘</a>
    <a href="social.html">ã‚½ãƒ¼ã‚·ãƒ£ãƒ«</a>
  </header>

  <main>
    <h2>æ²ç¤ºæ¿</h2>
    <p>ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œæˆã¾ãŸã¯å‚åŠ </p>

    <!-- ä¸Šéƒ¨ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆã‚¹ãƒ¬ãƒƒãƒ‰ä½œæˆç”¨ï¼‰ -->
    <div id="form-top">
      <form id="formTop" autocomplete="off">
        <input id="name-top" placeholder="åå‰" required />
        <input id="trip-top" placeholder="ãƒˆãƒªãƒƒãƒ—" required />
        <br>
        <hr>
    <textarea id="message-top" placeholder="ã‚¹ãƒ¬ãƒƒãƒ‰å" style="width:22%; "></textarea>
    <p>ä¸é©åˆ‡ãªå†…å®¹ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã¯å‰Šé™¤ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™</p>
    <br>
        <button type="submit" id="submitBtnTop">ã‚¹ãƒ¬ãƒƒãƒ‰ä½œæˆ</button>
      </form>
    </div>
<p>ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§</p>
    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒˆ -->
    <ul id="messages"></ul>

    <!-- ä¸‹éƒ¨ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆè¿”ä¿¡ç”¨ï¼‰ -->
    <div id="form-reply" style="display:none;">
      <form id="formReply" autocomplete="off">
        <input id="name-reply" placeholder="åå‰" required />
        <input id="trip-reply" placeholder="ãƒˆãƒªãƒƒãƒ—" required />
        <textarea id="message-reply" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸" required></textarea>
        <input type="hidden" id="parent_id" />
        <button type="submit">è¿”ä¿¡æŠ•ç¨¿</button>
        <button type="button" id="cancelReplyBtn">è¿”ä¿¡ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </form>
    </div>
  </main>
  <hr>
  <p>è‡ªåˆ†ã®ç™ºè¨€ã«ã¯ååˆ†æ³¨æ„ã—ã¾ã—ã‚‡ã†ã€‚</p>

  <aside>
    <div class="side-title">menu</div>
    <div class="side">
      <ul></ul>
    </div>
  </aside>

  <footer>all rights reserved Â©watatawa Software 2021~2025</footer>

<script>
  const SUPABASE_URL = 'https://ftuamjkicezhtxfyujob.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ0dWFtamtpY2V6aHR4Znl1am9iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5ODk0NDcsImV4cCI6MjA2NzU2NTQ0N30.fu_4lkKnjeAeJTUGwc6KTVCrN2mqberTuGfLOwaWSeA';

  const headers = {
    'Content-Type': 'application/json',
    apikey: SUPABASE_KEY,
    Authorization: 'Bearer ' + SUPABASE_KEY,
  };

  let currentReplyThreadId = null;
  const openedThreads = new Set();

  async function generateTripHash(trip) {
    const data = new TextEncoder().encode(trip);
    const hash = await crypto.subtle.digest('SHA-256', data);
    return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('').slice(0, 12);
  }

 async function fetchMessages() {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/messages?select=id,text,parent_id,created_at&order=created_at.asc`, { headers });
  const data = await res.json();
  const ul = document.getElementById('messages');
  ul.innerHTML = '';

  const myTrip = localStorage.getItem('tripHash');
  const threads = data.filter(m => !m.parent_id).reverse();
  const replies = data.filter(m => m.parent_id);

  threads.forEach(thread => {
    // âœ… è¿”ä¿¡ä¸­ã§è‡ªåˆ†ä»¥å¤–ã®ã‚¹ãƒ¬ãƒƒãƒ‰ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
    if (currentReplyThreadId && thread.id !== currentReplyThreadId) return;

    const li = document.createElement('li');
    li.classList.add('thread');
    li.dataset.threadId = thread.id;


      const isMine = myTrip && thread.text.includes(`â—†${myTrip}`);

      const header = document.createElement('div');
      header.innerHTML = `
        ${thread.text}<br>
        <button onclick="setReply(${thread.id}, encodeURIComponent(\`${thread.text}\`))">è¿”ä¿¡</button>
        ${isMine ? `<button onclick="deleteMessage(${thread.id})">å‰Šé™¤</button>` : ''}
        <button onclick="reportMessage(${thread.id}, \`${thread.text}\`)">é€šå ±</button>
        <button class="toggleBtn">${openedThreads.has(thread.id) ? 'â–²' : 'â–¼'}</button>
      `;
      header.querySelector('.toggleBtn').onclick = e => {
        e.stopPropagation();
        const ul = li.querySelector('ul');
        const expanded = ul.style.display !== 'none';
        ul.style.display = expanded ? 'none' : 'block';
        if (expanded) {
          openedThreads.delete(thread.id);
          e.target.textContent = 'â–¼';
        } else {
          openedThreads.add(thread.id);
          e.target.textContent = 'â–²';
        }
      };

      li.appendChild(header);

      const replyUl = document.createElement('ul');
      replyUl.style.display = openedThreads.has(thread.id) ? 'block' : 'none';
      replies.filter(r => r.parent_id === thread.id).forEach(reply => {
        const replyLi = document.createElement('li');
        const isMineReply = myTrip && reply.text.includes(`â—†${myTrip}`);
        replyLi.innerHTML = `
          ${reply.text}<br>
          <button onclick="setReply(${thread.id}, encodeURIComponent(\`${reply.text}\`))">è¿”ä¿¡</button>
          ${isMineReply ? `<button onclick="deleteMessage(${reply.id})">å‰Šé™¤</button>` : ''}
          <button onclick="reportMessage(${reply.id}, \`${reply.text}\`)">é€šå ±</button>
        `;
        replyUl.appendChild(replyLi);
      });

      li.appendChild(replyUl);
      ul.appendChild(li);
    });
  }

  // ã‚¹ãƒ¬ãƒƒãƒ‰ä½œæˆ
  document.getElementById('formTop').addEventListener('submit', async e => {
    e.preventDefault();
    const name = document.getElementById('name-top').value;
    const trip = document.getElementById('trip-top').value;
    const message = document.getElementById('message-top').value;
    const tripHash = await generateTripHash(trip);
    const now = new Date().toLocaleString();
    const text = `[${now}] ${name}â—†${tripHash}ï¼š${message}`;

    localStorage.setItem('posterName', name);
    localStorage.setItem('posterTrip', trip);
    localStorage.setItem('tripHash', tripHash);

    await fetch(`${SUPABASE_URL}/rest/v1/messages`, {
      method: 'POST',
      headers,
      body: JSON.stringify([{ text, parent_id: null }]),
    });

    document.getElementById('message-top').value = '';
    fetchMessages();
  });

  // è¿”ä¿¡æŠ•ç¨¿
  document.getElementById('formReply').addEventListener('submit', async e => {
    e.preventDefault();
    const name = document.getElementById('name-reply').value;
    const trip = document.getElementById('trip-reply').value;
    const message = document.getElementById('message-reply').value;
    const parentId = document.getElementById('parent_id').value;
    const tripHash = await generateTripHash(trip);
    const now = new Date().toLocaleString();
    const text = `[${now}] ${name}â—†${tripHash}ï¼š${message}`;

    localStorage.setItem('posterName', name);
    localStorage.setItem('posterTrip', trip);
    localStorage.setItem('tripHash', tripHash);

    await fetch(`${SUPABASE_URL}/rest/v1/messages`, {
      method: 'POST',
      headers,
      body: JSON.stringify([{ text, parent_id: parentId }]),
    });

    // ãƒ•ã‚©ãƒ¼ãƒ å†…å®¹ã ã‘ã‚¯ãƒªã‚¢ï¼ˆè¿”ä¿¡çŠ¶æ…‹ã¯ç¶­æŒï¼‰
    document.getElementById('message-reply').value = '';
    fetchMessages();
  });

  // è¿”ä¿¡ãƒ•ã‚©ãƒ¼ãƒ åˆ‡ã‚Šæ›¿ãˆ
  function setReply(id, encodedText) {
    currentReplyThreadId = id;
    document.getElementById('form-top').style.display = 'none';
    document.getElementById('form-reply').style.display = 'block';
    document.getElementById('parent_id').value = id;

    document.getElementById('name-reply').value = localStorage.getItem('posterName') || '';
    document.getElementById('trip-reply').value = localStorage.getItem('posterTrip') || '';

    const text = decodeURIComponent(encodedText);
    const idx = text.indexOf('ï¼š');
    let replyText = '';
    if (idx >= 0) {
      replyText = text.slice(idx + 1, idx + 7);
    } else {
      replyText = text.length > 6 ? text.slice(0, 6) : text;
    }
    document.getElementById('message-reply').value = '>>> ' + replyText + '\n';

    // é¸æŠä¸­ä»¥å¤–ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’éè¡¨ç¤º
    const threads = document.querySelectorAll('#messages > li.thread');
    threads.forEach(thread => {
      if (Number(thread.dataset.threadId) === id) {
        thread.style.display = 'block';
      } else {
        thread.style.display = 'none';
      }
    });
  }

  function cancelReply() {
    currentReplyThreadId = null;
    document.getElementById('form-top').style.display = 'block';
    document.getElementById('form-reply').style.display = 'none';
    document.getElementById('parent_id').value = '';
    document.getElementById('message-reply').value = '';

    // ã™ã¹ã¦ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’è¡¨ç¤º
    const threads = document.querySelectorAll('#messages > li.thread');
    threads.forEach(thread => {
      thread.style.display = 'block';
    });
  }

  document.getElementById('cancelReplyBtn').addEventListener('click', cancelReply);

  async function deleteMessage(id) {
    const tripHash = localStorage.getItem('tripHash');
    const res = await fetch(`${SUPABASE_URL}/rest/v1/messages?id=eq.${id}&select=text`, { headers });
    const data = await res.json();
    if (!data.length || !data[0].text.includes(`â—†${tripHash}`)) {
      alert("ãƒˆãƒªãƒƒãƒ—ãŒä¸€è‡´ã—ã¾ã›ã‚“");
      return;
    }
    await fetch(`${SUPABASE_URL}/rest/v1/messages?id=eq.${id}`, { method: 'DELETE', headers });
    fetchMessages();
  }

  async function reportMessage(id, text) {
    const trip = localStorage.getItem("posterTrip") || "åŒ¿å";
    const reason = prompt("é€šå ±ç†ç”±") || "";
    const body = {
      message: `ğŸ“¢ é€šå ±\n\nID: ${id}\næœ¬æ–‡: ${text}\né€šå ±è€…ãƒˆãƒªãƒƒãƒ—: ${trip}\nç†ç”±: ${reason}`
    };
    await fetch("https://formspree.io/f/myzjqvpr", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    }).then(r => {
      if (r.ok) alert("é€šå ±ã—ã¾ã—ãŸ");
      else alert("é€šå ±å¤±æ•—");
    });
  }

  // åˆæœŸåŒ–
  window.addEventListener('DOMContentLoaded', async () => {
    const name = localStorage.getItem('posterName');
    const trip = localStorage.getItem('posterTrip');
    if (name) {
      document.getElementById('name-top').value = name;
      document.getElementById('name-reply').value = name;
    }
    if (trip) {
      document.getElementById('trip-top').value = trip;
      document.getElementById('trip-reply').value = trip;
      const hash = await generateTripHash(trip);
      localStorage.setItem('tripHash', hash);
    }
    fetchMessages();
    setInterval(fetchMessages, 1000);
  });
</script>
</body>
</html>
