<!DOCTYPE html>
<html lang="ja">
<head>
    <link rel="icon" href="icon.png" type="image/x-icon">
<meta charset="UTF-8">
<title>チャット</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="ページの説明">
<meta name="keywords" content="ページのキーワードA,B,C">

<meta charset="UTF-8" />
<audio id="remote-audio" autoplay></audio>

<style>
  
body {
    background-color: var(--darker-background-color) !important;
 
    margin: 0
}



</style>
<style>:root {
    --link-color: #4bacd2;
    --background-color: white;
    --dark-background-color: #f5f8fa;
    --darker-background-color: #f5f8fa;
    --almost-black: #292f33;
    --border: #e1e8ed;
    --darker-gray: #66757f;
    --default-text-color: black;
}






#navbar {
    position: fixed;
    background-color: var(--background-color);
    border-bottom: 1px solid rgba(0, 0, 0, 0.15);
    height: 46px;
    top: 0;
    left: 0;
    width: 100vw;
    z-index: 100;
    font-size: 13px;
    color: var(--darker-gray);
    padding-right: calc(100vw - 100%);
}

#navbar-line {
    top: 46px;
    position: fixed;
    border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    height: 1px;
    width: 100%;
    z-index: 99;
    left: 0;
}

#navbar-container {
    margin: 0 auto;
    max-width: 1222px;
}








#navbar a {
    color: var(--darker-gray);
    text-decoration: none;
    z-index: 98;
}

#navbar a:hover {
    color: var(--link-color);
}

#navbar-links a {
    padding: 13px 15px;
    /*padding-bottom: 16px;*/
    top: 8px;
    position: relative;
    /* border-bottom: 3px solid transparent; */
    transition: 0.2s;
}

/* To add new CSS styles to .menu-active. */
#navbar-links a.menu-active {
    padding-bottom: 16px;
}


#navbar-links a:hover {
    box-shadow: 0px -7px 0px -4px var(--link-color) inset;
    transition: 0.2s;
    padding-bottom: 16px;
}

.menu-active {
    box-shadow: 0px -7px 0px -4px var(--link-color) inset;
}

.menu-active:before {
    color: var(--link-color) !important;
}






#navbar-links {
    width: fit-content;
    margin-left: 7px;
}

#logo-image {
    height: 34px;
    width: 34px;
    margin-right: 8px;
    margin-left: 5px;
    vertical-align: middle;
    position: relative;
    top: 2px;
}
#logo-icon {
    padding: 13px 10px;
}

#results {
  position: absolute;
  top: 50px;
  right: 20px;
  width: 300px;
  background-color: rgb(247, 251, 255);
  border: 1px solid #e4e4e4;
  padding: 10px;
  display: none; /* 最初は非表示 */
  z-index: 1000;
}
.upside {
   
  position: absolute;

  top: 80px;  
  height: auto;            /* 上から20pxに固定 */
  left: 180px;              /* 中央に配置 */
  transform: translateX(-50%);
  width: 300px;
  padding: 10px;
  position: fixed;

  background-color: #f7fdff;
  border: 1px solid rgb(215, 215, 215);
  border-radius: 4px;
  font-size: 16px;
  z-index: 1000;  
}



.message {
    color: #585858;
  margin-top: 0.1px;    /* 上の余白を狭く */
  margin-bottom: 0.1px; /* 下の余白も狭く */
  line-height: 0.0001;   /* 行間も少し狭く */
  
}
.message:first-child {
  margin-top: 0;      /* 最初のメッセージは上マージン無し */
}

a {
    color: #4bacd2;
}



.text-box {
  word-wrap: break-word;     /* 単語の途中でも折り返す */
  white-space: normal;       /* 通常の折り返しを許可 */
  line-height: 1.4;          /* 行間を適切にする（好みに応じて） */
  margin: 0;                 /* 余白をなくす（任意） */
}
p {
    color: #676767;
  word-wrap: break-word;     /* 単語の途中でも折り返す */
  white-space: normal;       /* 通常の折り返しを許可 */
  line-height: 1.4;          /* 行間を適切にする（好みに応じて） */
  margin: 0;                 /* 余白をなくす（任意） */
}

a {
  word-wrap: break-word;     /* 単語の途中でも折り返す */
  white-space: normal;       /* 通常の折り返しを許可 */
  line-height: 1.4;          /* 行間を適切にする（好みに応じて） */
  margin: 0;                 /* 余白をなくす（任意） */
}

  #messages div {
    display: block;
    border-bottom: 1px solid #ccc;
    margin: 8px 0;
    padding: 4px;
    position: relative;
  }
  .message-info {
    white-space: nowrap;
    font-weight: bold;
    user-select: none;
    display: inline-block;
    margin-right: 8px;
  }
  .message-content {
    white-space: pre-wrap;
    display: inline-block;
    vertical-align: middle;
    max-width: 70%;
    word-break: break-word;
  }
  .timestamp {
    color: #666;
    font-size: 0.75em;
    margin-left: 8px;
    user-select: none;
  }
  .delete-btn {
    position: absolute;
    right: 4px;
    top: 50%;
    transform: translateY(-50%);
    background: transparent;
    border: none;
    color: #c00;
    font-size: 14px;
    cursor: pointer;
    padding: 0 6px;
    line-height: 1;
  }
  .delete-btn:hover {
    color: #f00;
  }
 
  input, button {
    box-sizing: border-box;
  }

  #partner-list {
    margin-bottom: 6px;
  }
  #partner-list span {
    display: inline-flex;
    align-items: center;
    background: #f6ffe9;
    padding: 2px 4px;
    margin: 0 3px 3px 0;
    border-radius: 4px;
    cursor: pointer;
    user-select: none;
    position: relative;
  }
  #partner-list span.selected {
    background: #fff3b4;
   
  }
  #partner-list .remove-btn {
    margin-left: 3px;
    color: #900;
    cursor: pointer;
    user-select: none;
    font-size: 4px;
    line-height: 1;
  }
  #partner-list .remove-btn:hover {
    color: #f00;
  }
  #partner-add {
    color: #ffffff;
    display: flex;
    gap: 4px;

    margin-bottom: 2px;
  }
  #partner-add input {
    color: #ffffff;
    flex-grow: 1;
    padding: 8px;
  }
  /* 投稿送信バー全体 */
  #send-bar {
    display: flex;
    align-items: center;
    background-color: #222; /* 黒寄りのグレー */
    padding: 6px 10px;
    border-radius: 6px;
    gap: 8px;
    margin-top: 12px;
  }
 
  /* メッセージ入力欄 */
  #msg {
    flex-grow: 1;
    padding: 8px;
    height: 3em; /* 2行分くらい */
    resize: none;
    border-radius: 4px;
    border: none;
    font-size: 1em;
    line-height: 1.4em;
  }
  /* 送信ボタン */
  #send-btn {
    background-color: #4a4a4a00;
    border: none;
    color: white;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
  }
  #send-btn:hover {
    background-color: rgba(146, 146, 146, 0.263);
  }
   #call-btn {
    background-color: #4a4a4a00;
    border: none;
    color: white;
    padding: 8px 16px;
    border-radius: 2px;
    cursor: pointer;
    font-weight: bold;
  }
  #call-btn:hover{
    background-color: #9a9a9a54;
  }
   #logout-btn {
    background-color: #ff94948f;
    border: none;
    color: rgb(0, 0, 0);
    padding: 4px 4px;
    border-radius: 2px;
    cursor: pointer;
    font-weight: bold;
    position: relative;
    left: 20px;
  }
   body { margin: 0; background: #fff; font-family: sans-serif; }

    #auth {
      border: 3px solid rgb(147, 158, 72);
      padding: 20px;
      width: 300px;
      margin: 100px auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
       #signup-btn {
    background-color: #83e87a;
    border: none;
    color: white;
    padding: 0px 0px;
    border-radius: 0px;
    cursor: pointer;
    font-weight: bold;
       }

           .row {
      border: 1.5px solid rgb(195, 195, 195);
      background-color: #80bdd5;
      padding: 4px;
      width: 50px;
      margin: 10px auto;
      display: none;
    position: relative;
      gap: 10px;
    }
      .row {
    display: flex;
    gap: 8px; /* 要素間の隙間 */
  }
       .userinfo {
    display: flex;
    gap: auto; /* 要素間の隙間 */
    border: 1px solid rgb(255, 255, 255);
      background-color: #ffffff;

      display: flex;
        margin: 0 auto; /* 左右中央寄せ */
  width: auto;  
 
  
    

  }



   
 #new-partner {
  background-color: #f7f7f7;
  
    flex-grow: 1;
    padding: 8px;
    height: 2em; /* 2行分くらい */
    resize: none;
    border-radius: 4px;
    border: none;
    font-size: 1em;
    line-height: 1.4em;
  }
  
      #add-partner-btn {
    background-color: #ffffff00;
    border: none;
    color: rgb(77, 77, 77);
    padding: 8px 16px;
    border-radius: 3px;
    cursor: pointer;
    font-weight: bold;
  }  
  .custom-file-upload {
  display: inline-block;
  padding: 8px 16px;
  background-color: #4a4a4a;
  color: white;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  transition: background-color 0.3s;
}

.custom-file-upload:hover {
  background-color: #313131;
}

#image-preview img {
  max-width: 120px;
  max-height: 120px;
  border-radius: 8px;
  object-fit: cover;
  display: block;
}


.footer {
  margin-top: 100px;              /* 上との間隔（必要に応じて調整） */
  padding: 15px 0;
  background-color: #222;
  color: #fff;
  text-align: center;
  font-size: 14px;
  width: 100%;
      position: relative;
  top: 173px;   /* 下に20px移動 */
 


}
  #chat {
        font-size: 10pt;
      width: 800px;              /* 必要に応じて調整 */
      height: 600px;             /* 高さを制限して */
      overflow-y: auto;          /* 縦方向スクロールを有効にする */
      border: 1px solid #ccc;    /* 枠線（任意） */
      padding: 10px;
      background: #f9f9f9;
      display: none;
        width: 60%;   
            position: relative;
  top: 80px; 
  left: 400px;




    }

      .row {
        font-size: 10pt;
      width: 500px;              /* 必要に応じて調整 */
      height: auto;             /* 高さを制限して */
      overflow-y: auto;          /* 縦方向スクロールを有効にする */
   
   
            position: relative;
  top: 60px; 
    margin: 0 auto; /* 左右中央寄せ */
    left: 369px;
  width: 251%;   


    }
h2 {
    font-size: 15pt;
    color: #585858;
    font-family: "Arial", "Helvetica", sans-serif;
 
    margin: 0px;
    padding: 0px;
}
    

a {
    font-size: 10pt;
    font-family: "Arial", "Helvetica", sans-serif;
 
    margin: 0px;
    padding: 0px;
}



    
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js" defer></script>

   <header><div id="navbar">   
    <div id="navbar-container">
    
        <div id="navbar-links">

                   <a href="index.html" id="logo-icon">
        <img src="iconnew.png" alt="アイコン" id="logo-image">
    </a>
    　　   <a href="index.html" ><span>ホーム</span></a>
    <a href="oshirase.html" ><span>お知らせ</span></a>
            <a href="chat.html" id="home" class="menu-active"><span class="nav-text">チャット</span></a>
          
          
            <a href="social.html" ><span>ソーシャル</span></a>
            <a href="post.html" ><span>掲示板</span></a>
            <a href="market.html" ><span>マーケット</span></a>

            <a style="color: #585858;">watatawa CHAT ver 2.1 (JavaScript)</a>
            </div>
            </div>
            </div>
            </header>
            </head>

<main><div id="text">
<div id="auth">
 <h2>チャット</h2>
 <p>ソーシャルアカウントでサインイン</p>
  <input id="nickname" placeholder="ニックネーム">
  <input id="password" type="password" placeholder="パスワード">
  <button id="signup-btn"></button>
 
  <button id="login-btn">サインイン</button>
     <div style="white-space: nowrap;">
<br>
  <a href="https://watatawasoftware.onrender.com/otoiawase.html">パスワードを忘れた場合</a>｜
  <a href="https://watatawasoftware.onrender.com/create.html">アカウントを作成</a>
    
 
 

</div>
</div>

<div id="chat">
  
  
  <p>To: <span id="current-partner"></span></p>
  <div id="call-popup" style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%);
 background:white; border:1px solid #ccc; padding:20px; text-align:center; z-index:9999;">
  <div id="call-status">接続中...</div>
  <div id="call-timer"></div>
  <button id="end-call-btn" style="margin-top:10px;">通話終了</button>
</div>



  <p id="unread-badge" style="color: red;"></p>

  <div id="messages"></div>


<div class="upside">
  <div class="userinfo">
  <p style="color: #4bacd2;">サインイン中: <span id="my-nickname"></span></p> 
    <button id="logout-btn">サインアウト</button>
    </div>
    <hr>
    <p style="color: #a2bec9;">トークルームにユーザーを追加</p>
  <div id="partner-add">
    <input id="new-partner" placeholder="ニックネームで追加">
    <button id="add-partner-btn">追加</button>


  </div>
     <p style="color: #66757f; font-size: 10px;">※連絡を取り合うにはお互いが追加し合う必要があります</p>
  <hr>
  <p>友達</p>
    <div id="partner-list" title="トーク相手を変更"></div>
     <p style="color: #66757f; font-size: 13px;">Created by watatawa Software　　watatawa CHAT 本サービスご利用の際は必ず読んでください<a href="riyoukiyaku.html">利用規約</a>　
      　制作：わたっちー　©2021~2025</p>
     <div class="row">
  <input id="msg" placeholder="メッセージ">

  <button id="send-btn" title="メッセージを送信">＞</button><button id="call-btn" title="音声通話を発信">☎</button>
 
<input type="file" id="file" accept="image/*,video/*" style="color: #f1f1f1;"> 
 </div>
</div>

</div>


</div>
</main>



</div>



</div>
</div>

</div>


</div>


</main>
<footer class="footer">
          <a href="otoiawase.html">お問い合わせフォーム</a><br>
      <a href="riyoukiyaku.html">利用規約</a>
  <p>all rights reserved ©watatawa Software 2021~2025</p>
</footer>


    <audio id="call-audio" src="call.mp3" preload="auto"></audio>

 </div>
 </div>
 </div>




<script defer="">
    const displayedMessageIds = new Set();  // ← すでに表示されたメッセージIDを記録

document.addEventListener("DOMContentLoaded", () => {
  const supabaseUrl = "https://mbjvhxpozxylwcemnbcr.supabase.co";
  const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ianZoeHBvenh5bHdjZW1uYmNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIxMzM3MzAsImV4cCI6MjA2NzcwOTczMH0.JddcQ5SoHfR-OWGma__X8iP0OphdnLHOPdYjm3Ca2Qo";
  const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);

  let currentUser = null;
  let currentPartner = null;
  let messagePolling = null;
  let partners = [];

  // DOM Elements
  const partnerListEl = document.getElementById("partner-list");
  const currentPartnerEl = document.getElementById("current-partner");
  const unreadBadgeEl = document.getElementById("unread-badge");

  document.getElementById("signup-btn").onclick = signup;
  document.getElementById("login-btn").onclick = login;
  document.getElementById("send-btn").onclick = sendMessage;
  document.getElementById("logout-btn").onclick = logout;
  document.getElementById("add-partner-btn").onclick = addPartner;

  // ローカルストレージに保存していたuser情報を復元するがパートナーはDBから取得する
  const storedUser = localStorage.getItem("user");
  if (storedUser) {
    currentUser = JSON.parse(storedUser);
    showChat();
    loadPartnersFromDB();
  }

  function insertLineBreaks(text, maxLen = 30) {
    const regex = new RegExp(`.{1,${maxLen}}`, 'g');
    return (text.match(regex) || []).join('\n');
  }

  async function signup() {
    const nickname = document.getElementById("nickname").value.trim();
    const password = document.getElementById("password").value;
    if (!nickname || !password) return alert("ニックネームとパスワードを入力してください");

    const { data: exists, error: existsErr } = await supabaseClient
      .from("users")
      .select("id")
      .eq("nickname", nickname)
      .single();
    if (exists) return alert("ニックネームは既に使われています");
    if (existsErr && existsErr.code !== 'PGRST116') return alert("登録エラー：" + existsErr.message);

    const { error } = await supabaseClient
      .from("users")
      .insert({ nickname, password });

    if (error) return alert("登録失敗: " + error.message);
    alert("登録成功！ログインしてください");
  }
  


  async function login() {
    const nickname = document.getElementById("nickname").value.trim();
    const password = document.getElementById("password").value;
    if (!nickname || !password) return alert("ニックネームとパスワードを入力してください");

    const { data, error } = await supabaseClient
      .from("users")
      .select("*")
      .eq("nickname", nickname)
      .eq("password", password)
      .single();

    if (error || !data) return alert("ログイン失敗: ニックネームまたはパスワードが間違っています");

    currentUser = data;
    localStorage.setItem("user", JSON.stringify(currentUser));
    showChat();
    loadPartnersFromDB();
  }

  function showChat() {
    document.getElementById("auth").style.display = "none";
    document.getElementById("chat").style.display = "block";

    document.getElementById("my-nickname").textContent = currentUser.nickname;

    if (messagePolling) clearInterval(messagePolling);
    messagePolling = setInterval(loadMessages, 1000);
  }

async function sendMessage() {
  if (!currentPartner) return alert("会話する相手を選択してください");

  const content = document.getElementById("msg").value.trim();
  const fileInput = document.getElementById("file");
  const file = fileInput.files[0];
  if (!content && !file) return alert("メッセージ、画像、または動画を入力してください");

  const { data: toUser, error: toError } = await supabaseClient
    .from("users")
    .select("*")
    .eq("nickname", currentPartner)
    .single();

  if (toError || !toUser) return alert("相手が見つかりません");

  let image_url = null;
  let video_url = null;

  if (file) {
    const ext = file.name.split(".").pop().toLowerCase();
    const path = `${currentUser.id}/${Date.now()}-${file.name}`;

    const bucket = ext === "mp4" ? "chat-videos" : "chat-images";
    const { error: uploadError } = await supabaseClient.storage
      .from(bucket)
      .upload(path, file);

    if (uploadError) return alert("ファイルアップロード失敗: " + uploadError.message);

    const { data: urlData } = supabaseClient.storage.from(bucket).getPublicUrl(path);

    if (ext === "mp4") {
      video_url = urlData.publicUrl;
    } else {
      image_url = urlData.publicUrl;
    }
  }

  const { error } = await supabaseClient
    .from("messages")
    .insert({
      sender_id: currentUser.id,
      receiver_id: toUser.id,
      content,
      image_url,
      video_url
    });

  if (error) return alert("送信失敗: " + error.message);

  document.getElementById("msg").value = "";
  fileInput.value = "";

  await addPartnerToDB(currentPartner);
  loadMessages();
}


  async function loadMessages() {
  if (!currentPartner) return;

  

  const { data: toUser } = await supabaseClient
    .from("users")
    .select("*")
    .eq("nickname", currentPartner)
    .single();

  if (!toUser) return;

  const { data, error } = await supabaseClient
    .from("messages")
    .select("*")
    .or(`sender_id.eq.${currentUser.id},receiver_id.eq.${currentUser.id}`)
    .order("created_at", { ascending: true });

  if (error) return console.error(error);

  const filtered = data.filter(msg =>
    (msg.sender_id === currentUser.id && msg.receiver_id === toUser.id) ||
    (msg.sender_id === toUser.id && msg.receiver_id === currentUser.id)
  );

    const box = document.getElementById("messages");
  box.innerHTML = ""; // 古いメッセージを削除
  displayedMessageIds.clear(); // 表示済みIDもリセット

  let unreadCount = 0;

  for (const msg of filtered) {
  if (displayedMessageIds.has(msg.id)) continue;
  displayedMessageIds.add(msg.id);

  const div = document.createElement("div");
  div.dataset.messageId = msg.id;

  // ★ここでニックネームに変更
  const senderLabel = msg.sender_id === currentUser.id ? currentUser.nickname : toUser.nickname;

  const messageText = insertLineBreaks(msg.content || "", 30);
  const timestamp = new Date(msg.created_at).toLocaleString();

  div.innerHTML = `
    <span class="message-info">${senderLabel}</span>
    <span class="message-content">${messageText}</span>
    <span class="timestamp">${timestamp}</span>
  `;

  // 画像・動画の挿入処理...


    if (msg.image_url) {
      const img = document.createElement("img");
      img.src = msg.image_url;
      img.alt = "画像";
      img.style.maxWidth = "200px";
      img.style.display = "block";
      div.appendChild(img);
    }

    if (msg.video_url) {
      const video = document.createElement("video");
      video.src = msg.video_url;
      video.controls = true;
      video.muted = true;
      video.playsInline = true;
      video.style.maxWidth = "300px";
      video.style.display = "block";
      div.appendChild(video);
    }

    if (msg.sender_id === currentUser.id) {
      const btn = document.createElement("button");
      btn.className = "delete-btn";
      btn.textContent = "送信取り消し";
      btn.title = "メッセージを削除しますか？";
      btn.onclick = () => deleteMessage(msg.id);
      div.appendChild(btn);
    }

    box.appendChild(div);

    if (msg.receiver_id === currentUser.id && !msg.read) {
      unreadCount++;
    }
  }
  

  unreadBadgeEl.textContent = unreadCount > 0 ? `未読メッセージ: ${unreadCount}` : "";
}
  // パートナー一覧をDBから取得
  async function loadPartnersFromDB() {
    if (!currentUser) return;

    const { data, error } = await supabaseClient
      .from("user_partners")
      .select("partner_nickname")
      .eq("user_id", currentUser.id);

    if (error) {
      console.error(error);
      return;
    }

    partners = data.map(p => p.partner_nickname);
    renderPartnerList();

    if (partners.length > 0 && !currentPartner) {
      setCurrentPartner(partners[0]);
    } else if (partners.length === 0) {
      setCurrentPartner(null);
    }
  }

  // パートナー一覧をDBに追加（重複チェックはDBのユニーク制約に任せる）
  async function addPartnerToDB(nick) {
    if (!currentUser) return;
    if (!nick || partners.includes(nick) || nick === currentUser.nickname) return;

    const { error } = await supabaseClient
      .from("user_partners")
      .insert({ user_id: currentUser.id, partner_nickname: nick });

    if (error) {
      if (error.code === "23505") {
        // 重複エラーは無視
      } else {
        alert("パートナー追加失敗: " + error.message);
      }
      return;
    }

    partners.push(nick);
    renderPartnerList();
  }

  async function deleteMessage(messageId) {
  const { error } = await supabaseClient
    .from("messages")
    .delete()
    .eq("id", messageId)
    .eq("sender_id", currentUser.id);  // 念のため本人確認

  if (error) {
    alert("削除に失敗しました: " + error.message);
    return;
  }

  // DOMから削除
  const el = document.querySelector(`[data-message-id="${messageId}"]`);
  if (el) el.remove();

  displayedMessageIds.delete(messageId);  // 再取得時に表示できるようにする（任意）
}


  // パートナー一覧描画（削除ボタン付き）
  function renderPartnerList() {
    partnerListEl.innerHTML = "";
    partners.forEach((p, i) => {
      const sp = document.createElement("span");
      sp.textContent = p;
      sp.className = (p === currentPartner) ? "selected" : "";
      sp.onclick = () => setCurrentPartner(p);

      const delBtn = document.createElement("button");
      delBtn.textContent = "Delete";
      delBtn.title = "パートナーを削除";
      delBtn.className = "del-partner-btn";
      delBtn.onclick = async (e) => {
        e.stopPropagation();
        if (!confirm(`「${p}」をトークルームから削除しますか？（受信するには再度追加する必要があります）`)) return;

        const { error } = await supabaseClient
          .from("user_partners")
          .delete()
          .eq("user_id", currentUser.id)
          .eq("partner_nickname", p);

        if (error) {
          alert("削除失敗: " + error.message);
          return;
        }

        partners.splice(i, 1);
        renderPartnerList();

        if (currentPartner === p) {
          if (partners.length > 0) {
            setCurrentPartner(partners[0]);
          } else {
            setCurrentPartner(null);
            document.getElementById("messages").innerHTML = "";
            unreadBadgeEl.textContent = "";
          }
        }
      };

      sp.appendChild(delBtn);
      partnerListEl.appendChild(sp);
    });
  }

  function setCurrentPartner(nick) {
    currentPartner = nick;
    currentPartnerEl.textContent = nick || "";
    renderPartnerList();
    loadMessages();
  }

  function addPartner() {
    const input = document.getElementById("new-partner");
    const val = input.value.trim();
    if (!val) return alert("相手のニックネームを入力してください");
    if (val === currentUser.nickname) return alert("自分のニックネームは追加できません");
    if (partners.includes(val)) return alert("すでにリストにあります");

    addPartnerToDB(val);
    input.value = "";
  }

  function logout() {
    currentUser = null;
    currentPartner = null;
    partners = [];
    localStorage.removeItem("user");
    document.getElementById("chat").style.display = "none";
    document.getElementById("auth").style.display = "block";
    document.getElementById("messages").innerHTML = "";
    document.getElementById("my-nickname").textContent = "";
    currentPartnerEl.textContent = "";
    unreadBadgeEl.textContent = "";
    document.getElementById("nickname").value = "";
    document.getElementById("password").value = "";
    document.getElementById("msg").value = "";
    document.getElementById("new-partner").value = "";
    if (messagePolling) clearInterval(messagePolling);
  }
  let localStream = null;
  let peerConnection = null;
  let callChannel = null;
  const callAudio = document.getElementById("call-audio");
  const callPopup = document.getElementById("call-popup");
  const callStatus = document.getElementById("call-status");
  const callTimerEl = document.getElementById("call-timer");
  let callTimerInterval = null;

  document.getElementById("call-btn").onclick = startCall;
  document.getElementById("end-call-btn").onclick = endCall;

  // 発信処理
async function startCall() {
  if (!currentPartner) return alert("通話相手を選択してください");

  const { data: partnerUser } = await supabaseClient
    .from("users")
    .select("*")
    .eq("nickname", currentPartner)
    .single();
  if (!partnerUser) return alert("相手が見つかりません");

  await prepareCallConnection(true);

  // offer を作成し、calls に登録
  const offer = await peerConnection.createOffer();
  await peerConnection.setLocalDescription(offer);

  // 重複通話を避けるため削除
  await supabaseClient.from("calls")
    .delete()
    .eq("caller_id", currentUser.id)
    .eq("callee_id", partnerUser.id);

  await supabaseClient.from("calls").insert({
    caller_id: currentUser.id,
    callee_id: partnerUser.id,
    type: "offer",
    sdp_offer: JSON.stringify(offer)
  });

  showCallPopup("発信中...");
  callAudio.play().catch(e => console.warn("発信音再生失敗:", e));
}

async function prepareCallConnection(isCaller) {
  peerConnection = new RTCPeerConnection({
    iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
  });

  localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
  localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

  peerConnection.ontrack = event => {
    console.log("✅ 相手の音声トラック受信:", event.streams);
    const remoteAudio = document.getElementById("remote-audio");
    remoteAudio.srcObject = event.streams[0];
    remoteAudio.muted = false;
    remoteAudio.play().catch(e => {
      console.warn("音声再生失敗:", e);
    });
      callAudio.pause();
  callAudio.currentTime = 0;
  };

  peerConnection.onicecandidate = async (event) => {
    if (event.candidate) {
      await supabaseClient.from("calls").insert({
        caller_id: currentUser.id,
        callee_id: currentPartner.id,
        type: "ice",
        candidate: JSON.stringify(event.candidate)
      });
    }
  };
}

function showCallPopup(status) {
  callStatus.textContent = status;
  callTimerEl.textContent = "";
  callPopup.style.display = "block";
  let seconds = 0;
  callTimerInterval = setInterval(() => {
    seconds++;
    const min = Math.floor(seconds / 60);
    const sec = seconds % 60;
    callTimerEl.textContent = `通話時間: ${min}:${sec.toString().padStart(2, "0")}`;
  }, 1000);
}

function endCall() {
  if (peerConnection) peerConnection.close();
  if (localStream) localStream.getTracks().forEach(track => track.stop());
  peerConnection = null;
  localStream = null;

  callAudio.pause();
  callAudio.currentTime = 0;

  callPopup.style.display = "none";
  clearInterval(callTimerInterval);
}

supabaseClient.channel("calls")
  .on("postgres_changes", {
    event: "INSERT",
    schema: "public",
    table: "calls"
  }, async payload => {
    const call = payload.new;

    if (call.callee_id != currentUser.id) return; // ← 型の違いも吸収

    // オファー受信時
    if (call.type === "offer" && call.sdp_offer) {
      const { data: callerUser, error } = await supabaseClient
        .from("users")
        .select("*")
        .eq("id", call.caller_id)
        .single();

      if (error || !callerUser) return console.error("発信者取得失敗");

      // 着信音
      callAudio.pause();
      callAudio.currentTime = 0;
      callAudio.play().catch(e => console.warn("着信音再生失敗:", e));

      const accept = confirm(`INCOMEING CALL 「${callerUser.nickname}」からの着信`);
      if (!accept) return;

      currentPartner = callerUser.nickname; // 通話相手として設定
      await prepareCallConnection(false); // 受信者として準備

      const offer = JSON.parse(call.sdp_offer);
      await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));

      const answer = await peerConnection.createAnswer();
      await peerConnection.setLocalDescription(answer);

      await supabaseClient.from("calls").insert({
        caller_id: currentUser.id,
        callee_id: call.caller_id,
        type: "answer",
        sdp_answer: JSON.stringify(answer)
      });

      showCallPopup("通話中...");
    }

    // アンサー受信時
    if (call.type === "answer" && call.sdp_answer && peerConnection) {
      const answer = JSON.parse(call.sdp_answer);
      await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
      showCallPopup("通話中...");
    }

    // ICE candidate 受信時
    if (call.type === "ice" && call.candidate && peerConnection) {
      const candidate = JSON.parse(call.candidate);
      await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
    }
  }).subscribe();





  
});



</script>



</div></body></html>