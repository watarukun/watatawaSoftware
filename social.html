<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ソーシャル</title>
  <link rel="icon" href="icon.png" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="ページの説明">
<meta name="keywords" content="ページのキーワードA,B,C">
<link rel="stylesheet" href="index.css">
  <style>
    body { margin: 0; background: #fff; font-family: sans-serif; }
    #login-form {
      border: 3px solid rgb(72, 158, 72); padding: 20px; width: 300px;
      margin: 100px auto; display: flex; flex-direction: column; gap: 10px;
    }
    #signout-button, #upload-container {
      display: none; position: absolute; right: 20px;
      padding: 10px; background: #222; color: white; border: none; cursor: pointer; z-index: 100;
    }
    #signout-button { top: 20px; }
    #upload-container { top: 70px; }
    #error-message { color: red; }
 
    #a-scene {
    visibility: hidden;
    opacity: 0;
    width: 100vw;
    height: 100vh;
    transition: opacity 0.5s ease;
  }
  </style>
</head>
<body>
    <div id="outer">
<header><div id="header-inner"><h1>watatawa Software</h1><a href="index.html">トップページ</a> ｜<a href="market.html">マーケット【ガフ市】</a> ｜ <a href="download.html">ダウンロード</a>  ｜ <a href="post.html">掲示板</a> ｜  <a href="guff.html">ガフ札情報</a>  ｜<a href="guffimage.html">ガフの写真集</a> ｜ <a href="chat.html">チャット</a>｜ <a href="social.html">ソーシャル</a>
</header>
</div>
    

<div id="login-form">

  <h2>ソーシャルへサインイン</h2>
  <p>チャットで作成したアカウントでサインインしてください</p>
  <input type="text" id="nickname" placeholder="ニックネーム">
  <input type="password" id="password" placeholder="パスワード">
  <button id="signin-button">サインイン</button>
  <p id="error-message"></p>
</div>

<button id="signout-button">サインアウト</button>
<div id="upload-container">
  <label for="upload-model-input" style="cursor:pointer;">3Dモデルアップロード</label>
  <input type="file" id="upload-model-input" accept=".glb,.gltf" style="display:none;">
</div>

<a-scene id="a-scene" embedded>
  <a-assets>
    <a-asset-item id="treeModel" src="tree.glb"></a-asset-item>
    <a-asset-item id="houseModel" src="house.glb"></a-asset-item>
    <a-asset-item id="stopModel" src="stop.glb"></a-asset-item>
    <a-asset-item id="otherModel" src="other.glb"></a-asset-item>
  </a-assets>

  <a-sky color="#222"></a-sky>
  <a-light type="directional" position="1 3 2" intensity="1"></a-light>

  <a-plane rotation="-90 0 0" width="200" height="200" color="#7BC8A4"></a-plane>

  <a-entity id="house" gltf-model="#houseModel" position="0 0 15" scale="11 11 11"></a-entity>
  <a-entity id="tree" gltf-model="#treeModel" position="5 0 -15" scale="22 22 22"></a-entity>
  <a-entity id="stop" gltf-model="#stopModel" position="22 0 -15" scale="0.2 0.2 0.2"></a-entity>

  <a-entity id="player" position="0 -1 0">
    <a-entity id="user-model" position="0 1 6" movable-model></a-entity>
    <a-entity id="camera" camera position="0 4.2 0" look-controls="pointerLockEnabled: true"></a-entity>
  </a-entity>
</a-scene>


<script>
const supabase = window.supabase.createClient(
  'https://mbjvhxpozxylwcemnbcr.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ianZoeHBvenh5bHdjZW1uYmNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIxMzM3MzAsImV4cCI6MjA2NzcwOTczMH0.JddcQ5SoHfR-OWGma__X8iP0OphdnLHOPdYjm3Ca2Qo'
);

let userId = null;
const loginForm = document.getElementById('login-form');
const signoutButton = document.getElementById('signout-button');
const uploadContainer = document.getElementById('upload-container');
const aScene = document.getElementById('a-scene');
const errorMessage = document.getElementById('error-message');
const userModel = document.getElementById('user-model');
const playerEntity = document.getElementById('player');
const otherPlayers = {}; // 他プレイヤー管理

// ---- movalbe-model コンポーネントは必ずグローバルに1回だけ定義 ----
// 重複登録防止
if (!AFRAME.components['movable-model']) {
  AFRAME.registerComponent('movable-model', {
    schema: { speed: { type: 'number', default: 4 } },
    init() {
      this.keys = {};
      this.camera = document.querySelector('#camera').object3D;
      this.colliders = [
        document.querySelector('#house').object3D,
        document.querySelector('#tree').object3D,
        document.querySelector('#stop').object3D
      ];
      window.addEventListener('keydown', e => { this.keys[e.code] = true; });
      window.addEventListener('keyup', e => { this.keys[e.code] = false; });
    },
    tick(time, delta) {
      const el = this.el.parentEl;
      const pos = el.object3D.position.clone();
      const move = new THREE.Vector3();

      if (this.keys['KeyS']) move.z -= 1;
      if (this.keys['KeyW']) move.z += 1;
      if (this.keys['KeyA']) move.x -= 1;
      if (this.keys['KeyD']) move.x += 1;
      if (move.length() === 0) return;

      move.normalize();
      const direction = new THREE.Vector3();
      this.camera.getWorldDirection(direction);
      direction.y = 0; direction.normalize();
      const right = new THREE.Vector3().crossVectors(new THREE.Vector3(0,1,0), direction).normalize();

      const movement = new THREE.Vector3();
      movement.addScaledVector(direction, -move.z);
      movement.addScaledVector(right, move.x);
      movement.normalize();
      movement.multiplyScalar(this.data.speed * delta / 1000);

      const nextPos = pos.clone().add(movement);

      const playerBox = new THREE.Box3().setFromCenterAndSize(nextPos, new THREE.Vector3(0.6, 1.5, 0.6));
      for (let collider of this.colliders) {
        const colliderBox = new THREE.Box3().setFromObject(collider);
        if (colliderBox.intersectsBox(playerBox)) {
          console.log("衝突検知：移動中止");
          return;
        }
      }

      el.object3D.position.copy(nextPos);
    }
  });
}

// 向きの反映（省略）...
// 同期ループ間隔は1秒に修正
// 定期的に送信
function startPositionSync() {
  setInterval(() => {
    if (!userId) return;
    const pos = playerEntity.object3D.position;
    const camRot = document.querySelector('#camera').object3D.rotation;
    updatePlayerState(pos, camRot.y);
  }, 1000);
}

// 他プレイヤー表示時
function onOtherPlayerUpdate(player) {
  if (!userId || player.user_id === userId) return;

  let ent = otherPlayers[player.user_id];
  if (!ent) {
    ent = document.createElement('a-entity');
    ent.setAttribute('gltf-model', '#otherModel');
    ent.setAttribute('scale', '2 2 2');
    aScene.appendChild(ent);
    otherPlayers[player.user_id] = ent;
  }

  ent.setAttribute('position', `${player.x} ${player.y} ${player.z}`);

  if (typeof player.rotation_y === 'number') {
    const degY = THREE.MathUtils.radToDeg(player.rotation_y);
    ent.setAttribute('rotation', `0 ${degY} 0`);
  }
}



// サインインボタン押下
document.getElementById('signin-button').onclick = async () => {
  const nickname = document.getElementById('nickname').value.trim();
  const password = document.getElementById('password').value.trim();
  if (!nickname || !password) {
    errorMessage.innerText = 'ニックネームとパスワードを入力';
    return;
  }
  const { data, error } = await supabase.from('users').select('*').eq('nickname', nickname).eq('password', password).single();
  if (error || !data) {
    errorMessage.innerText = '認証失敗';
    return;
  }

  // ヘッダー非表示
  document.querySelector('#outer > header').style.display = 'none';

  // シーン表示
  aScene.style.visibility = 'visible';
  aScene.style.opacity = '1';
  aScene.style.display = 'block';

  userId = data.id;
  loginForm.style.display = 'none';
  signoutButton.style.display = 'block';
  uploadContainer.style.display = 'block';

  // 初期位置登録
  await updatePlayerState({ x: 0, y: 0, z: 0 }, 0);

  subscribePlayerStates(onOtherPlayerUpdate);
  startPositionSync();
};

// ポインターロック（1回だけ）
aScene.addEventListener('click', () => {
  aScene.requestPointerLock();
}, { once: true });

// サインアウトはリロード
signoutButton.onclick = () => location.reload();

// 3Dモデルアップロード
document.getElementById('upload-model-input').addEventListener('change', e => {
  const file = e.target.files[0];
  if (file) userModel.setAttribute('gltf-model', URL.createObjectURL(file));
});

// 位置と回転をSupabaseへアップサート
// 位置と回転をSupabaseへアップサート
async function updatePlayerState(position, rotationY) {
  if (!userId) return;
  if (
    typeof position.x !== 'number' || 
    typeof position.y !== 'number' || 
    typeof position.z !== 'number' || 
    typeof rotationY !== 'number'
  ) {
    console.warn('updatePlayerStateに不正な値:', position, rotationY);
    return;
  }
  const { error } = await supabase.from('positions').upsert({
    user_id: userId,
    x: position.x,
    y: position.y,
    z: position.z,
    rotation_y: rotationY,
    updated_at: new Date().toISOString()
  }, { onConflict: 'user_id' });
  if (error) console.error('updatePlayerState error:', error);
}

// 1秒ごとに自分の位置・回転をアップデート（1秒間隔固定）
function startPositionSync() {
  setInterval(() => {
    if (!userId) return;
    const pos = playerEntity.object3D.position;
    const rot = playerEntity.object3D.rotation;
    console.log('送信位置:', pos, '送信回転(rot.y):', rot.y);
    updatePlayerState(pos, rot.y);
  }, 1000);
}

// シーンがロードされたら位置同期を開始
aScene.addEventListener('loaded', () => {
  console.log('a-scene loaded, start position sync');
  startPositionSync();
});

// 他プレイヤーの位置と回転を反映
function onOtherPlayerUpdate(player) {
  if (!userId || player.user_id === userId) return;

  let ent = otherPlayers[player.user_id];
  if (!ent) {
    ent = document.createElement('a-entity');
    ent.setAttribute('gltf-model', '#otherModel');
    ent.setAttribute('scale', '2 2 2');
    aScene.appendChild(ent);
    otherPlayers[player.user_id] = ent;
  }

  ent.setAttribute('position', `${player.x} ${player.y} ${player.z}`);

  if (typeof player.rotation_y === 'number') {
    const degY = THREE.MathUtils.radToDeg(player.rotation_y);
    ent.setAttribute('rotation', `0 ${degY} 0`);  // 横向きのみ適用
  }
}

// Realtime購読セットアップ（positionsテーブル）
function subscribePlayerStates(onChange) {
  supabase.channel('positions_channel')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'positions' }, payload => {
      onChange(payload.new);
    })
    .subscribe();
}

// 1秒ごとに自分の位置・回転をアップデート
function startPositionSync() {
  setInterval(() => {
    if (!userId) return;
    const pos = playerEntity.object3D.position;
    const rot = playerEntity.object3D.rotation;
    updatePlayerState(pos, rot.y);
  }, 1);
}

const rot = playerEntity.object3D.rotation;
// rotation.yはラジアンのままでOK
updatePlayerState(pos, rot.y);

if (typeof player.rotation_y === 'number') {
  // ラジアンから度数（角度）へ変換
  const degY = THREE.MathUtils.radToDeg(player.rotation_y);
  ent.setAttribute('rotation', `0 ${degY} 0`);
}




function startPositionSync() {
  setInterval(() => {
    if (!userId) return;
    const pos = playerEntity.object3D.position;
    const camRot = document.querySelector('#camera').object3D.rotation;
    updatePlayerState(pos, camRot.y);  // cameraのy回転だけ送信
  }, 10);
}


</script>



</body>
</html>
