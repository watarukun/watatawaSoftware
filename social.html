<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ソーシャル</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="ページの説明">
<meta name="keywords" content="ページのキーワードA,B,C">
<link rel="stylesheet" href="index.css">
  <link rel="icon" href="icon.png" type="image/x-icon">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <style>
    body { margin: 0; background: #ffffff; color: rgb(38, 38, 38); font-family: sans-serif; }
    #login-form {
      border: 3px solid rgb(71, 155, 71);
      padding: 20px;
      width: 300px;
      margin: 100px auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    #signout-button {
      display: none;
      position: absolute;
      top: 20px; right: 20px;
      padding: 10px;
      background: rgb(94, 197, 130);
      color: white;
      border: none;
      cursor: pointer;
      z-index: 100;
    }
    #a-scene {
      display: none;
      width: 100vw;
      height: 100vh;
    }
    #upload-container {
      display: none;
      position: absolute;
      top: 70px;
      right: 20px;
      background: #222;
      padding: 10px;
      border-radius: 5px;
      z-index: 110;
    }
    #error-message { color: red; }
  </style>
</head>
<body>
    <div id="outer">
<header><div id="header-inner"><h1>watatawa Software</h1><a href="index.html">トップページ</a> ｜<a href="market.html">マーケット【ガフ市】</a> ｜ <a href="download.html">ダウンロード</a>  ｜ <a href="post.html">掲示板</a> ｜  <a href="guff.html">ガフ札情報</a>  ｜<a href="guffimage.html">ガフの写真集</a> ｜ <a href="chat.html">チャット</a>｜ <a href="social.html">ソーシャル</a>


<div id="login-form">
  <h2>ソーシャルへサインイン</h2>
  <p>チャットで作成したアカウントでサインインしてください</p>
  <input type="text" id="nickname" placeholder="ニックネーム" />
  <input type="password" id="password" placeholder="パスワード" />
  <button id="signin-button">サインイン</button>
  <p id="error-message"></p>
</div>

<button id="signout-button">サインアウト</button>

<div id="upload-container">
  <label for="upload-model-input" style="cursor:pointer; color:#eee;">
    3Dモデルアップロード（glTF/GLB）
  </label>
  <input type="file" id="upload-model-input" accept=".glb,.gltf" style="display:none" />
</div>

<a-scene id="a-scene" embedded>
  <a-sky color="#222"></a-sky>
  <a-light type="directional" color="#fff" intensity="1" position="1 3 2"></a-light>
  <!-- 3Dモデル表示用 -->
  <a-entity id="user-model" position="0 1 -3"></a-entity>
  <a-entity camera position="0 1.6 0" wasd-controls look-controls></a-entity>
</a-scene>

<script>
  const supabase = window.supabase.createClient(
    'https://mbjvhxpozxylwcemnbcr.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ianZoeHBvenh5bHdjZW1uYmNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIxMzM3MzAsImV4cCI6MjA2NzcwOTczMH0.JddcQ5SoHfR-OWGma__X8iP0OphdnLHOPdYjm3Ca2Qo'
  );

  const loginForm = document.getElementById('login-form');
  const signoutButton = document.getElementById('signout-button');
  const aScene = document.getElementById('a-scene');
  const uploadContainer = document.getElementById('upload-container');
  const errorMessage = document.getElementById('error-message');
  const userModel = document.getElementById('user-model');

  document.getElementById('signin-button').addEventListener('click', async () => {
    const nickname = document.getElementById('nickname').value.trim();
    const password = document.getElementById('password').value;

    errorMessage.innerText = '';
    if (!nickname || !password) {
      errorMessage.innerText = 'ニックネームとパスワードを入力してください';
      return;
    }

    const { data, error } = await supabase
      .from('users')
      .select('*')
      .eq('nickname', nickname)
      .eq('password', password)
      .single();

    if (error || !data) {
      errorMessage.innerText = '認証失敗';
      return;
    }

    loginForm.style.display = 'none';
    signoutButton.style.display = 'block';
    aScene.style.display = 'block';
    uploadContainer.style.display = 'block';
  });

  signoutButton.addEventListener('click', () => {
    location.reload();
  });

  // 3Dモデルアップロード処理
  document.getElementById('upload-model-input').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const url = URL.createObjectURL(file);

    // 直接 user-model の gltf-model に Blob URLをセット
    userModel.setAttribute('gltf-model', url);

    // Blob URLは使い終わったら開放したほうがいいが、
    // 表示継続のため今回は解放しないでおきます
  });
</script>

</body>
</html>
